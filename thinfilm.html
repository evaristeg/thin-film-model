<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      body {
        background-color: black;
        color: #d8d8d8;
      }
      .canvas_frame {
        width: 800px;
        height: 120px;
        border: 10px solid black;
      }
      .below {
        width: 800px;
        height: 120px;
        border: 0;
        display: inline;
        float: left;
        margin-right: -800px;
      }
      .above {
        width: 800px;
        height: 120px;
        border: 0;
        display: inline;
        float: right;
      }
    </style>
    <script src="complex.js"></script>
    <script src="piecewise.js"></script>
    <script src="colorspace.js"></script>
    <script src="radiometry.js"></script>
    <script src="thinfilm.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(function() { updateIlluminant(); });

      var specRange = [380, 750];
      var maxThickness = 2000;
      var illuminant;
      var bounds;

      function selectorClicked(event) {
        var cnv = document.getElementById("selector");
        var x = (event.clientX - cnv.getBoundingClientRect().left) / cnv.width;
        var t = Math.pow(x, 2) * maxThickness;
        document.getElementById('thickness').value = t;
        argsUpdated();
      }

      function thicknessUpdated() {
        doUpdate(false);
      }

      function angleUpdated() {
        var thickness = document.getElementById('thickness').value;
        var angle = document.getElementById('angle').value;
        var cos = Math.cos(angle * Math.PI / 180.);
        var oldMax = maxThickness;
        maxThickness = 2000. * cos;
        thickness = thickness * maxThickness / oldMax;
        document.getElementById('thickness').value = thickness;
        doUpdate(true);
      }

      function argsUpdated() {
        doUpdate(true);
      }

      function updateIlluminant() {
        if (document.getElementById('illum_flat').checked) { illuminant = illuminants.flat; }
        else if (document.getElementById('illum_d65').checked) { illuminant = illuminants.cieD65; }
        else if (document.getElementById('illum_bb').checked) {
          illuminant = illuminants.blackbody(document.getElementById('bb_temp').value);
        }
        doUpdate(true);
      }

      function doUpdate(rerender) {
        var thickness = document.getElementById('thickness').value;
        var angle = document.getElementById('angle').value;
        var iorFilm = document.getElementById('ior_f').value;
        var iorBack = document.getElementById('ior_b').value;
        var pol = document.getElementById('pol').value;
        var ws = (pol < 0 ? 0 : 0.5);
        var wp = (pol > 0 ? 0 : 0.5);

        if (rerender) {
            bounds = paintInterference("if_progression", illuminant, 0, maxThickness, angle, iorFilm, iorBack, ws, wp);
        }

        var filter = generateFilter(thickness, angle, iorFilm, iorBack, ws, wp);
        var reflected = illuminant.multiply(filter);

        var data_i = google.visualization.arrayToDataTable([['nm','illuminant']].concat(illuminant.samples));
        var data_f = google.visualization.arrayToDataTable([['nm','reflectance']].concat(filter.samples));
        var data_r = google.visualization.arrayToDataTable([['nm','reflected']].concat(reflected.samples));

        var r = document.getElementById('chart_illum').getBoundingClientRect();

        var options = {
          theme: 'maximized',
          curveType: 'function',
          colors: ['#d8d8d8'],
          backgroundColor: 'transparent',
          chartArea: {
            left: 0,
            top: 0,
            width: r.width,
            height: r.height
          },
          hAxis: {
            baselineColor: 'white',
            gridlines: { color: 'transparent' },
            viewWindow: { min: specRange[0], max: specRange[1] },
            textStyle: { color: 'transparent' }
          },
          vAxis: {
            baselineColor: 'white',
            gridlines: { color: 'transparent' },
            viewWindow: {
              min: 0
            },
            textStyle: { color: '#c8c8c8' }
          },
          legend: {
            position: 'none'
          },
          pointsVisible: false,
        };

        if (rerender) {
          var chart_i = new google.visualization.LineChart(document.getElementById('chart_illum'));
          chart_i.draw(data_i, options);
        }
        options.vAxis.viewWindow.max = 1.05 * bounds.reflectanceHi;
        var chart_f = new google.visualization.LineChart(document.getElementById('chart_filter'));
        chart_f.draw(data_f, options);
        options.vAxis.viewWindow.max = 1.05 * bounds.reflectedHi;
        options.hAxis.textStyle.color = '#c8c8c8';
        var chart_r = new google.visualization.LineChart(document.getElementById('chart_reflect'));
        chart_r.draw(data_r, options);

        var canv = document.getElementById('selector');
        var ctx = canv.getContext("2d");
        ctx.clearRect(0, 0, canv.width, canv.height);
        var x = Math.sqrt(thickness / maxThickness) * canv.width;
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x + 0.5, 0);
        ctx.lineTo(x + 0.5, canv.height);
        ctx.stroke();
        var c = cie1931observer.spectrumToXyz(reflected);
        c = colorspace.XYZ_to_srgb_linear_clamp(c);
        var i;
        for (i = 0; i < 3; i++) { c[i] = (c[i] - bounds.rgbLo) / (bounds.rgbHi - bounds.rgbLo); }
        c = colorspace.srgb_linear_to_srgb(c);
        c = colorspace.hexify(c);
        ctx.lineWidth = 2;
        ctx.fillStyle = c;
        ctx.fillRect(x - 17, canv.height / 2 - 17, 35, 34);
        ctx.strokeRect(x - 17, canv.height / 2 - 17, 35, 34);
      }
    </script>
  </head>
  <body>
    <p>
      Illuminant:<br>
      <input type="radio" name="illum_radio" id="illum_flat" onchange="updateIlluminant()" checked> Flat<br>
      <input type="radio" name="illum_radio" id="illum_d65" onchange="updateIlluminant()"> CIE D65 (daylight)<br>
      <input type="radio" name="illum_radio" id="illum_bb" onchange="updateIlluminant()"> Blackbody: 
      <input type="number" id="bb_temp" min="1" max="50000" value="6500" onchange="updateIlluminant()"> K
    </p>
    <p>
      Film thickness: <input type="number" id="thickness" min="0" max="2000" value="600" onchange="thicknessUpdated()"> nm
      Angle of incidence: <input type="number" id="angle" min="0" max="89" value="0" onchange="angleUpdated()"> degrees
      Film IOR: <input type="number" id="ior_f" min="1.0" max="5.0" value="1.33" step="0.01" onchange="argsUpdated()">
      Back IOR: <input type="number" id="ior_b" min="1.0" max="1000" value="1.0" step="0.05" onchange="argsUpdated()">
      Polarization: <input type="number" id="pol" min="-1" max="1" value="0" step="1" onchange="argsUpdated()">
    </p>
    <div class="canvas_frame">
      <canvas id="underlay1" class="below"></canvas>
      <div id="chart_illum" class="above"></div>
    </div>
    <div class="canvas_frame">
      <canvas id="underlay2" class="below"></canvas>
      <div id="chart_filter" class="above"></div>
    </div>
    <div class="canvas_frame">
      <canvas id="underlay3" class="below"></canvas>
      <div id="chart_reflect" class="above"></div>
    </div>
    <div class="canvas_frame">
      <canvas id="if_progression" class="below"></canvas>
      <canvas id="selector" class="above" onclick="selectorClicked(event)"></canvas>
    </div>
  </body>
  <script type="text/javascript">
    (function () {
      var canvases = document.getElementsByTagName('canvas');
      var i;
      for (i = 0; i < canvases.length; i++) {
        canvases[i].width = parseInt(window.getComputedStyle(canvases[i]).width, 10);
        canvases[i].height = parseInt(window.getComputedStyle(canvases[i]).height, 10);
      }
    })();
    paintVisibleSpectrum("underlay1", specRange[0], specRange[1]);
    paintVisibleSpectrum("underlay2", specRange[0], specRange[1]);
    paintVisibleSpectrum("underlay3", specRange[0], specRange[1]);
  </script>
</html>

